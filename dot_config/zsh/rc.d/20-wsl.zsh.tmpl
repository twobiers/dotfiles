#!/usr/bin/env zsh

{{ if eq .chezmoi.os "linux" }}
{{ if (.chezmoi.kernel.osrelease | lower | contains "microsoft") }}
# Only necessary when on WSL

# NTFS Mounts in WSL2 are slow as they are used under the 9P protocol
# Therefore we exclude the drives. However, notice that this could affect
# commands like code or docker that provide native interopt.

ZSH_HIGHLIGHT_DIRS_BLACKLIST+=(/mnt/c)
# We excluded the windows path. Make sure that we can still use some interop programs
path+=(
#  "/mnt/c/Users/{{ .user.windows }}/AppData/Local/Programs/Microsoft VS Code/bin"
  "/mnt/c/Program Files/Microsoft VS Code/bin"
  "/mnt/c/Program Files/Docker/Docker/resources/bin"
)

keep_current_path() {
  printf "\e]9;9;%s\e\\" "$(wslpath -w "$PWD")"
}
precmd_functions+=(keep_current_path)

# Works a bit
# To make it work on systemd-based WSL2:
# sudo systemctl disable --global gpg-agent.socket
# sudo systemctl disable --global gpg-agent-extra.socket
# sudo systemctl disable --global gpg-agent-ssh.socket
# sudo systemctl disable --global gpg-agent-browser.socket
# sudo systemctl disable --global dirmngr.socket

# Now the relay is managed by systemd. Activate using:
# systemctl --user enable ssh.service 
# systemctl --user enable gpg.service
# systemctl --user start ssh 
# systemctl --user start gpg
export SSH_AUTH_SOCK=$HOME/.ssh/agent.sock
export GPG_AGENT_SOCK=$HOME/.gnupg/S.gpg-agent


# We use pass backend for aws-vault
export AWS_VAULT_BACKEND=pass
{{ end }}
{{ end }}
